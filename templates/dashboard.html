<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ”’ Network Security Monitor</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #ffffff;
            min-height: 100vh;
        }
        
        .header {
            background: rgba(0,0,0,0.3);
            padding: 1rem 2rem;
            border-bottom: 2px solid #4ecdc4;
        }
        
        .header h1 {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 1.8rem;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.5rem;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(0,0,0,0.2);
            padding: 0.5rem 1rem;
            border-radius: 25px;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto auto;
            gap: 1.5rem;
            padding: 2rem;
            height: calc(100vh - 120px);
        }
        
        .widget {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        .widget h3 {
            margin-bottom: 1rem;
            color: #4ecdc4;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }
        
        .stat-card {
            background: rgba(0,0,0,0.2);
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #4ecdc4;
        }
        
        .alert-item {
            background: rgba(0,0,0,0.2);
            margin: 0.5rem 0;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #ff6b6b;
        }
        
        .alert-time {
            font-size: 0.8rem;
            opacity: 0.7;
        }
        
        .controls {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .btn {
            background: #4ecdc4;
            color: #1e3c72;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: #45b7b8;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: #ff6b6b;
            color: white;
        }
        
        .btn-danger:hover {
            background: #ff5252;
        }
        
        #traffic-chart {
            height: 300px;
            width: 100%;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
                padding: 1rem;
            }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>
            <i class="fas fa-shield-alt"></i>
            Network Security Monitor
        </h1>
        <div class="status-bar">
            <div class="status-indicator">
                <i class="fas fa-circle pulse" style="color: #4ecdc4;"></i>
                <span>Sistema Attivo</span>
            </div>
            <div class="status-indicator">
                <i class="fas fa-clock"></i>
                <span id="uptime">00:00:00</span>
            </div>
            <div class="status-indicator">
                <i class="fas fa-wifi"></i>
                <span id="connection-status">Connesso</span>
            </div>
        </div>
    </header>
    
    <main class="dashboard-grid">
        <!-- Statistiche Generali -->
        <div class="widget">
            <h3><i class="fas fa-chart-bar"></i> Statistiche Live</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-threats">0</div>
                    <div>Minacce Rilevate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="blocked-threats">0</div>
                    <div>IP Bloccati</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="active-connections">0</div>
                    <div>Connessioni Attive</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-packets">0</div>
                    <div>Pacchetti Analizzati</div>
                </div>
            </div>
        </div>
        
        <!-- Alert Recenti -->
        <div class="widget">
            <h3><i class="fas fa-exclamation-triangle"></i> Alert Recenti</h3>
            <div id="alerts-container" style="max-height: 300px; overflow-y: auto;">
                <!-- Gli alert saranno inseriti qui dinamicamente -->
            </div>
        </div>
        
        <!-- Grafico Traffico -->
        <div class="widget full-width">
            <h3><i class="fas fa-chart-line"></i> Traffico di Rete Real-Time</h3>
            <div id="traffic-chart"></div>
        </div>
        
        <!-- Controlli di Sicurezza -->
        <div class="widget">
            <h3><i class="fas fa-cogs"></i> Controlli di Sicurezza</h3>
            <div class="controls">
                <button class="btn" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i> Aggiorna
                </button>
                <button class="btn" onclick="exportReport()">
                    <i class="fas fa-download"></i> Esporta Report
                </button>
                <button class="btn btn-danger" onclick="emergencyBlock()">
                    <i class="fas fa-ban"></i> Blocco Emergenza
                </button>
            </div>
            <div id="blocked-ips" style="margin-top: 1rem;">
                <h4>IP Bloccati:</h4>
                <div id="blocked-list"></div>
            </div>
        </div>
        
        <!-- Sistema Status -->
        <div class="widget">
            <h3><i class="fas fa-heartbeat"></i> Stato Sistema</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="cpu-usage">0%</div>
                    <div>CPU</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="memory-usage">0%</div>
                    <div>Memoria</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="network-usage">0 KB/s</div>
                    <div>Rete</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="alert-rate">0/min</div>
                    <div>Rate Alert</div>
                </div>
            </div>
        </div>
    </main>
    
    <script>
        // Inizializza SocketIO
        const socket = io();
        
        // Variabili globali
        let trafficChart = null;
        
        // Gestione connessione
        socket.on('connect', function() {
            console.log('Connesso al server');
            document.getElementById('connection-status').textContent = 'Connesso';
            socket.emit('get_live_data');
        });
        
        socket.on('disconnect', function() {
            console.log('Disconnesso dal server');
            document.getElementById('connection-status').textContent = 'Disconnesso';
        });
        
        // Aggiornamento dati live
        socket.on('live_data', function(data) {
            updateStats(data.stats);
            updateAlerts(data.alerts);
            updateTrafficChart(data.traffic);
        });
        
        // Nuovo alert
        socket.on('new_alert', function(alert) {
            addAlert(alert);
        });
        
        // Aggiornamento dashboard
        socket.on('dashboard_update', function(data) {
            if (data.traffic) {
                updateTrafficChart(data.traffic);
            }
            if (data.threat_stats) {
                updateStats({threat_stats: data.threat_stats});
            }
        });
        
        // Funzioni di aggiornamento
        function updateStats(stats) {
            if (stats.threat_stats) {
                document.getElementById('total-threats').textContent = stats.threat_stats.threats_detected || 0;
                document.getElementById('blocked-threats').textContent = stats.threat_stats.threats_blocked || 0;
            }
            
            if (stats.network_stats) {
                document.getElementById('active-connections').textContent = stats.network_stats.recent_connections || 0;
                document.getElementById('total-packets').textContent = stats.network_stats.total_packets || 0;
            }
        }
        
        function updateAlerts(alerts) {
            const container = document.getElementById('alerts-container');
            container.innerHTML = '';
            
            alerts.forEach(alert => {
                addAlert(alert);
            });
        }
        
        function addAlert(alert) {
            const container = document.getElementById('alerts-container');
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert-item';
            
            const icon = getAlertIcon(alert.level || alert.severity);
            
            alertDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${icon} ${alert.threat_type || alert.reason || 'Alert'}</strong>
                        <div>IP: ${alert.source_ip || alert.ip || 'Unknown'}</div>
                        <div class="alert-time">${alert.timestamp}</div>
                    </div>
                    <button class="btn btn-danger" onclick="blockIP('${alert.source_ip || alert.ip}')">
                        Blocca
                    </button>
                </div>
            `;
            
            container.insertBefore(alertDiv, container.firstChild);
            
            // Mantieni solo ultimi 10 alert
            while (container.children.length > 10) {
                container.removeChild(container.lastChild);
            }
        }
        
        function getAlertIcon(level) {
            const icons = {
                'info': 'ðŸ”µ',
                'warning': 'ðŸŸ¡',
                'critical': 'ðŸ”´',
                'blocked': 'ðŸš«',
                'low': 'ðŸ”µ',
                'medium': 'ðŸŸ¡',
                'high': 'ðŸ”´'
            };
            return icons[level] || 'âš ï¸';
        }
        
        function updateTrafficChart(trafficData) {
            if (trafficData && trafficData.data) {
                if (!trafficChart) {
                    trafficChart = Plotly.newPlot('traffic-chart', trafficData.data, trafficData.layout, {
                        responsive: true,
                        displayModeBar: false
                    });
                } else {
                    Plotly.redraw('traffic-chart');
                }
            }
        }
        
        // Funzioni di controllo
        function refreshData() {
            socket.emit('get_live_data');
        }
        
        function blockIP(ip) {
            if (ip && ip !== 'Unknown') {
                fetch(`/api/block/${ip}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log('IP bloccato:', data);
                        updateBlockedList();
                    });
            }
        }
        
        function exportReport() {
            alert('FunzionalitÃ  di export in sviluppo');
        }
        
        function emergencyBlock() {
            if (confirm('Attivare il blocco di emergenza?')) {
                alert('Blocco di emergenza attivato');
            }
        }
        
        function updateBlockedList() {
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    console.log('Stats aggiornate:', data);
                });
        }
        
        // Aggiorna uptime
        setInterval(() => {
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    if (data.uptime) {
                        document.getElementById('uptime').textContent = data.uptime;
                    }
                })
                .catch(err => console.log('Errore stats:', err));
        }, 5000);
        
        // Richiedi dati iniziali
        setTimeout(() => {
            socket.emit('get_live_data');
        }, 1000);
    </script>
</body>
</html>